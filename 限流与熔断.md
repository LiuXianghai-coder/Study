# 限流与熔断

- 服务雪崩
  - 一个服务失败，导致整条链路的服务都失败的情形，称之为服务雪崩
  - 解决方案：采用服务熔断和服务降级就可以视为解决服务雪崩
- 服务限流
  - 通过限制并发访问数或者限制一个时间窗口内允许处理的请求数量来保护系统。
- 服务熔断
  - 当某个服务提供者无法正常为服务调用者提供服务时，为了防止服务雪崩，暂时将出现故障的接口隔离出来，后续一段时间内该服务调用者的请求都会直接失败，直到目标服务恢复正常
  - 熔断是一个框架级别的处理
- 服务降级
  - 下游服务因为由于某种原因响应过慢，下游服务主动停掉一些不太重要的业务，释放出服务器资源，增加响应速度
  -  当下游的服务因为某种原因不可用，上游服务主动调用本地的一些降级逻辑，避免卡顿，迅速返回给用户
  - 服务降级大多属于一种业务级别的处理
  - 自己梳理出核心业务和非核心业务，在非核心业务流程上要加上开关，一旦发现系统抗不住，关掉开关，结束这些次要流程



## 服务熔断和降级的方案

- 平均响应时间
  - 一段时间内的平均响应时间超过阈值，那么在接下来的一个固定的时间窗口内，对这个方法的访问都会自动熔断
- 异常比例
  - 当某个方法每秒调用获得的异常总数的比例超过设定的阈值时，自动进入降级状态。在接下来的一个固定的时间窗口内，对这个方法的调用都会自动返回
- 异常数量
  - 和异常比例类似，当某个方法在指定的时间窗口内获得的异常数量超过阈值时，会触发熔断

### 常见的限流算法

- 计数器法

  - 在指定周期内，累计访问次数达到阈值，触发限流策略。当进入下一个时间周期时进行访问次数的清零
  - 存在的问题：临界问题

- 滑动窗口算法

  - 将一个窗口划分为若干个等份的小窗口，每个小窗口对应不同的时间点，拥有独立的计数器。整个窗口的所有累计数不能大于阈值

- 令牌桶限流算法

  - 常用于网络流量整形和速率限制中最常见的算法

  - 特点：速度恒定、令牌桶大小固定。如果令牌桶被填满，则会丢弃令牌；如果桶内没有令牌，则调用限流策略

  - 出现的几种情况

    > 1. 请求速度 > 令牌生成速度，当令牌桶内没有令牌时，出现限流
    > 2. 请求速度 = 令牌生成速度，流量处于平稳状态
    > 3. 请求速度 < 令牌生成速度，请求可以被正常处理

- 漏桶限流算法

  - 不管请求的速率有多快，处理的速度始终是不变的
  - 消息中间件常用这种算法
  - 主要作用：控制数据注入网络的速度；平滑网络上的突发流量



## `Sentinal`

- 概述
  - 面向分布式服务架构的轻量级流量控制组件。以流量为切入点，从限流、流量整形、服务降级、系统负载保护等多个维度来帮助保障微服务的稳定性
- 